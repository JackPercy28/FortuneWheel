<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lucky Spin</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            max-width: 500px;
            width: 100%;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(to right, #ff7e5f, #feb47b);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .content {
            padding: 30px;
        }
        
        .registration-form {
            width: 100%;
            padding: 0 10px; /* Add some padding on mobile */
            box-sizing: border-box;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px; /* Prevent zoom on iOS */
            box-sizing: border-box;
        }

        .submit-btn {
            background: linear-gradient(to right, #ff7e5f, #feb47b);
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 50px;
            font-size: 1.3rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            box-sizing: border-box;
        }
        
        .wheel-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto 30px auto;
        }
        
        .wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            transition: transform 4s cubic-bezier(0.17, 0.67, 0.83, 0.67);
            box-shadow: 0 0 0 10px white, 0 0 20px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .wheel-segment {
            position: absolute;
            width: 50%;
            height: 50%;
            left: 50%;
            top: 0;
            transform-origin: left bottom;
            overflow: hidden;
        }
        
    
        
      .segment-image {
            position: absolute;
            left: 35%;
            top: 50%;
            transform: translate(-50%, -50%) rotate(80deg);
            transform-origin: center center;
            text-align: center;
            width: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .segment-image img {
            width: 50px;  /* Smaller size */
            height: 50px; /* Smaller size */
            object-fit: contain;
            filter: drop-shadow(1px 1px 2px rgba(0, 0, 0, 0.5));
        }
        
        .wheel-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background-color: white;
            border-radius: 50%;
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            border: 4px solid #ff7e5f;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }
        
        .wheel-pointer {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 40px;
            background-color: #ff7e5f;
            clip-path: polygon(50% 100%, 0 0, 100% 0);
            z-index: 20;
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3));
        }
        
        .btn-spin {
            background: linear-gradient(to right, #ff7e5f, #feb47b);
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 50px;
            font-size: 1.3rem;
            font-weight: 600;
            cursor: pointer;
            display: block;
            margin: 0 auto 20px auto;
            box-shadow: 0 5px 15px rgba(255, 126, 95, 0.4);
            transition: all 0.3s;
        }
        
        .btn-spin:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 126, 95, 0.6);
        }
        
        .btn-spin:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .result {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 10px;
        }
        
        .prize-text {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ff7e5f;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .prize-icon {
            width: 40px;
            height: 40px;
            object-fit: contain;
        }
        
        .user-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .admin-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px; /* Add padding for small screens */
            box-sizing: border-box;
        }

        .admin-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            margin: 0 auto; /* Center horizontally */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .admin-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            flex-wrap: wrap;
            overflow-x: auto; /* Allow horizontal scrolling on mobile */
        }

        .admin-tab {
            padding: 10px 15px; /* Smaller padding on mobile */
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem; /* Smaller font on mobile */
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap; /* Prevent text wrapping */
            flex-shrink: 0; /* Don't shrink tabs */
        }
        
        .admin-tab.active {
            color: #ff7e5f;
            border-bottom-color: #ff7e5f;
        }
        
        .admin-tab-content {
            display: none;
        }
        
        .admin-tab-content.active {
            display: block;
        }
        
        .export-btn {
            background: #2ed573;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            transition: all 0.3s;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .status-bar {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 0.9rem;
        }
        
        .firebase-status {
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin: 10px 0;
            text-align: center;
        }
        
        .status-connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        /* Prize Management Styles */
        .prize-item {
            display: grid;
            grid-template-columns: 40px 1fr auto;
            gap: 12px;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #e1e5e9;
            border-radius: 10px;
            background: #ffffff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .prize-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            transform: translateY(-1px);
        }

        .prize-color {
            width: 30px;
            height: 30px;
            border-radius: 8px;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
        }

        .preview-small {
            width: 28px;
            height: 28px;
            object-fit: contain;
            border-radius: 6px;
            border: 1px solid #e1e5e9;
            background: white;
            padding: 2px;
        }

        .prize-inputs {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 2fr auto;
            gap: 8px;
            align-items: center;
            width: 100%;
        }

        .prize-name {
            grid-column: 1;
        }

        .prize-probability {
            grid-column: 2;
        }

        .prize-color-input {
            grid-column: 3;
            width: 100%;
            height: 40px;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            cursor: pointer;
        }

        .prize-image-input-container {
            grid-column: 4;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .prize-image-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            font-size: 0.8rem;
            background: #fafbfc;
        }

        .remove-prize {
            grid-column: 5;
            background: #ff4757;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 40px;
        }

        .remove-prize:hover {
            background: #ff3742;
            transform: scale(1.05);
        }

        .prize-inputs input {
            padding: 10px 12px;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            font-size: 0.9rem;
            background: #fafbfc;
            transition: all 0.3s ease;
            width: 100%;
            box-sizing: border-box;
        }

        .prize-inputs input:focus {
            border-color: #ff7e5f;
            background: white;
            box-shadow: 0 0 0 3px rgba(255, 126, 95, 0.1);
            outline: none;
        }

        .prize-probability {
            text-align: center;
            font-weight: 600;
        }

        .prize-probability::after {
            content: "%";
            position: absolute;
            right: 10px;
            color: #666;
        }

        .prize-image-input-container {
            display: flex;
            flex-direction: column; /* Stack on mobile */
            gap: 10px;
            width: 100%;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .admin-panel {
                padding: 15px;
                align-items: flex-start; /* Start from top on mobile */
                justify-content: center;
            }
            
            .admin-content {
                padding: 20px;
                width: 95%;
                max-height: 85vh;
                margin-top: 20px; /* Add some top margin */
            }
        }

        @media (max-width: 480px) {
            .admin-panel {
                padding: 10px;
            }
            
            .admin-content {
                padding: 15px;
                width: 98%;
                max-height: 80vh;
            }
        }

        /* Live Winners Styles */
        .winner-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            margin: 10px 0;
            background: white;
            border-radius: 10px;
            border-left: 5px solid #ff7e5f;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            animation: slideIn 0.5s ease-out;
        }

        .winner-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .winner-item.new {
            background: linear-gradient(135deg, #fff9e6 0%, #fff0cc 100%);
            border-left-color: #ffa502;
            animation: highlight 2s ease-in-out;
        }

        .winner-prize-icon {
            width: 40px;
            height: 40px;
            object-fit: contain;
            border-radius: 8px;
            padding: 5px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .winner-details {
            flex: 1;
        }

        .winner-name {
            font-weight: bold;
            font-size: 1.1rem;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .winner-prize {
            color: #ff7e5f;
            font-weight: 600;
            font-size: 1rem;
        }

        .winner-meta {
            display: flex;
            gap: 15px;
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 5px;
        }

        .winner-time {
            background: #e3f2fd;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .winner-company {
            background: #e8f5e8;
            padding: 3px 8px;
            border-radius: 12px;
        }


        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes highlight {
            0% { background: linear-gradient(135deg, #ffeb3b 0%, #ffc107 100%); }
            50% { background: linear-gradient(135deg, #ffeb3b 0%, #ffc107 100%); }
            100% { background: linear-gradient(135deg, #fff9e6 0%, #fff0cc 100%); }
        }

        /* Empty state */
        .empty-winners {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .empty-winners i {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }

        /* For larger screens, use horizontal layout */
        @media (min-width: 768px) {
            .prize-item {
                flex-direction: row;
                align-items: center;
            }
            
            .prize-inputs {
                flex-direction: row;
            }
            
            .prize-image-input-container {
                flex-direction: row;
            }
        }
        
        .prize-name {
            flex: 2;
        }
        
        .prize-probability {
            flex: 1;
            max-width: 80px;
        }
        
        .prize-color-input {
            flex: 0.5;
            max-width: 60px;
            height: 40px;
            padding: 0;
            border: none;
        }
        
        .remove-prize {
            background: #ff4757;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .add-prize {
            background: #2ed573;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 15px;
            width: 100%;
        }
        
        .admin-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .save-btn {
            background: #3742fa;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            flex: 1;
        }
        
        .reset-btn {
            background: #ffa502;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            flex: 1;
        }
        
        .probability-total {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .probability-info {
            text-align: center;
            margin: 15px 0;
            padding: 12px;
            background: #e3f2fd;
            border-radius: 8px;
            font-size: 0.85rem;
            color: #1565c0;
            border-left: 4px solid #2196f3;
        }

        .export-options {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .export-section {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            border: 1px solid #e1e5e9;
        }

        .export-section h4 {
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .export-section p {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .bottom-admin-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: auto;
            background: #2c3e50;
            color: white;
            padding: 12px 12px; /* Reduced padding */
            text-align: center;
            z-index: 999;
            border-radius: 50%; /* Make it circular */
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            width: 70px; /* Fixed width */
            height: 70px; /* Fixed height */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .bottom-admin-btn {
            background: linear-gradient(to right, #ff7e5f, #feb47b);
            color: white;
            border: none;
            padding: 0; /* Remove padding */
            border-radius: 50%;
            font-size: 1.5rem; /* Adjust icon size */
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(255, 126, 95, 0.4);
            transition: all 0.3s;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .bottom-admin-btn:hover {
            transform: translateY(-2px) scale(1.1);
            box-shadow: 0 5px 15px rgba(255, 126, 95, 0.6);
        }

        @keyframes celebrate {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .celebrate {
            animation: celebrate 0.5s ease-in-out 3;
        }

        /* ADD THESE NEW STYLES */
        .switch-user-btn, .new-spin-btn, .new-user-btn {
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            margin: 5px;
            transition: all 0.3s;
        }

        .switch-user-btn {
            background: #6c757d;
            color: white;
        }

        .new-spin-btn {
            background: #28a745;
            color: white;
        }

        .new-user-btn {
            background: #dc3545;
            color: white;
        }

        .switch-user-btn:hover, .new-spin-btn:hover, .new-user-btn:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }

        /* Image Upload Styles */
        .upload-preview {
            text-align: center;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #ddd;
        }

        .uploaded-image-item {
            position: relative;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 5px;
            transition: all 0.3s;
        }

        .uploaded-image-item:hover {
            border-color: #ff7e5f;
            transform: scale(1.05);
        }

        .uploaded-image-item.selected {
            border-color: #28a745;
            background: #d4edda;
        }

        .uploaded-image-item img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: 5px;
        }

        .delete-uploaded-image {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: none;
        }

        .uploaded-image-item:hover .delete-uploaded-image {
            display: block;
        }

        .image-url-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .image-url-input input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .prize-image-input-container {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .preview-small {
            width: 30px;
            height: 30px;
            object-fit: contain;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }

        .prize-image-input {
            flex: 1;
            max-width: 200px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.8rem;
        }


        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .admin-content {
                padding: 15px;
                margin: 10px;
                max-width: 95vw;
            }
            
            .admin-tabs {
                font-size: 0.8rem;
            }
            
            .admin-tab {
                padding: 8px 12px;
                font-size: 0.8rem;
            }
            
            .prize-name {
                min-width: 100%; /* Full width on mobile */
            }
            
            .export-options {
                flex-direction: column; /* Stack export buttons */
            }
            
            .admin-actions {
                flex-direction: column; /* Stack action buttons */
            }
            
            .save-btn, .reset-btn {
                width: 100%; /* Full width buttons */
            }
            
            /* Make image upload section more compact */
            .export-section {
                padding: 15px;
            }
            
            /* Adjust wheel size for mobile */
            .wheel-container {
                width: 280px;
                height: 280px;
            }
        }

        @media (max-width: 768px) {
            .prize-item {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .prize-inputs {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .prize-inputs > * {
                grid-column: 1 !important;
            }
            
            .prize-image-input-container {
                grid-template-columns: 1fr auto;
            }
            
            .remove-prize {
                justify-self: start;
                margin-top: 10px;
            }
        }

        .admin-tab-content {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 480px) {
            .admin-content {
                padding: 10px;
                margin: 5px;
            }
            
            .admin-tab {
                padding: 6px 10px;
                font-size: 0.75rem;
            }
            
            .wheel-container {
                width: 250px;
                height: 250px;
            }
            
            .btn-spin {
                padding: 12px 30px;
                font-size: 1.1rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Lucky Spin</h1>
            <p>Spin to win amazing prizes!</p>
        </div>
        
        <div class="content">
            <div class="registration-form" id="registrationForm">
                <h2 style="text-align: center; margin-bottom: 20px; color: #333;">Enter Your Details</h2>
                
                <div id="firebaseStatus" class="firebase-status status-loading">
                    ğŸ”„ Initializing Firebase...
                </div>
                
                <form id="userForm">
                    <div class="form-group">
                        <label for="userName">Full Name *</label>
                        <input type="text" id="userName" name="name" required placeholder="Enter your full name">
                    </div>
                    
                    <div class="form-group">
                        <label for="userPhone">Phone Number *</label>
                        <input type="tel" id="userPhone" name="phone" required placeholder="Enter your phone number">
                    </div>
                    
                    <div class="form-group">
                        <label for="userEmail">Email Address *</label>
                        <input type="email" id="userEmail" name="email" required placeholder="Enter your email address">
                    </div>
                    
                    <div class="form-group">
                        <label for="userCompany">Company (Optional)</label>
                        <input type="text" id="userCompany" name="company" placeholder="Enter your company name">
                    </div>
                    
                    <button type="submit" class="submit-btn">Submit & Spin the Wheel</button>
                </form>
                
                <div class="status-bar">
                    <strong>Data Status:</strong><br>
                    Users: <span id="userCount">0</span> | 
                    Spins: <span id="spinCount">0</span>
                </div>
            </div>

            <div id="wheelGame" style="display: none;">
                <div class="user-info" id="userInfo">
                    <h4>Welcome!</h4>
                    <div class="user-details" id="userDetails"></div>
                </div>
                
                <div class="wheel-container">
                    <div class="wheel" id="wheel">
                        <!-- Wheel segments will be generated here -->
                    </div>
                    <div class="wheel-center">SPIN</div>
                    <div class="wheel-pointer"></div>
                </div>
                
                <button class="btn-spin" id="spinBtn">SPIN THE WHEEL</button>
                
                <div class="result">
                    <div>Your prize will appear here</div>
                    <div class="prize-text" id="prizeText">-</div>
                </div>

                <!-- ADDED BUTTONS FOR USER SWITCHING -->
                <div style="text-align: center; margin-top: 20px;">
                    <button class="new-spin-btn" onclick="newSpin()">
                        ğŸ¯ New Spin
                    </button>
                    <button class="switch-user-btn" onclick="switchUser()">
                        ğŸ”„ New User
                    </button>
                </div>
                
                <div id="gameFirebaseStatus" class="firebase-status status-loading">
                    ğŸ”„ Firebase Status
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Admin Panel Button -->
    <div class="bottom-admin-panel">
        <button class="bottom-admin-btn" onclick="showPasswordPanel()">
            ğŸ›¡ï¸
        </button>
    </div>

    <!-- Password Panel -->
    <div class="admin-panel" id="passwordPanel">
        <div class="admin-content">
            <div style="text-align: center;">
                <h2>Admin Access Required</h2>
                <p>Please enter the admin password:</p>
                <input type="password" id="passwordInput" style="width: 100%; padding: 12px; margin: 20px 0; border: 2px solid #ddd; border-radius: 8px;" placeholder="Enter password">
                <button class="submit-btn" onclick="checkPassword()" style="margin: 10px 0;">Access Admin Panel</button>
                <div id="passwordError" style="color: red; margin-top: 10px; display: none;">
                    Incorrect password. Please try again.
                </div>
            </div>
        </div>
    </div>

    <!-- Main Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <div class="admin-content">
            <div class="admin-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">Admin Panel - Complete Management</h2>
                <button class="remove-prize" onclick="hideAdminPanel()" style="margin: 0;">Close</button>
            </div>
            
            <div class="admin-tabs">
                <button class="admin-tab active" onclick="switchAdminTab('prizes')">ğŸ¯ Prize Management</button>
                <button class="admin-tab" onclick="switchAdminTab('export')">ğŸ“Š Data Export</button>
                <button class="admin-tab" onclick="switchAdminTab('analytics')">ğŸ“ˆ Analytics</button>
                <button class="admin-tab" onclick="switchAdminTab('winners')">ğŸ† Live Winners</button>
                <button class="admin-tab" onclick="switchAdminTab('settings')">âš™ï¸ Settings</button>
            </div>
            
            <!-- Prize Management Tab -->
            <div id="prizes-tab" class="admin-tab-content active">
                <div class="probability-info">
                    â“˜ Wheel shows equal segments, but prizes have different probabilities
                </div>
                
                <!-- ADD IMAGE UPLOAD SECTION HERE -->
                <div class="export-section" style="margin-bottom: 20px;">
                    <h4>ğŸ“ Image Upload</h4>
                    <p>Upload images for prizes (recommended: 80x80px PNG with transparent background)</p>
                    <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                        <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                        <button class="export-btn" onclick="document.getElementById('imageUpload').click()" style="background: #17a2b8; flex: 1;">
                            ğŸ“¸ Choose Image
                        </button>
                        <button class="export-btn" onclick="clearImageUpload()" style="background: #6c757d; flex: 0.5;">
                            ğŸ—‘ï¸ Clear
                        </button>
                    </div>
                    <div id="uploadPreview" style="margin-top: 15px; text-align: center; display: none;">
                        <img id="previewImage" style="max-width: 80px; max-height: 80px; border: 2px solid #ddd; border-radius: 8px; padding: 5px;">
                        <div style="margin-top: 10px;">
                            <button class="export-btn" onclick="useUploadedImage()" style="background: #28a745; padding: 8px 15px;">
                                âœ… Use for Selected Prize
                            </button>
                        </div>
                    </div>
                    <div id="uploadedImagesGallery" style="margin-top: 20px; display: none;">
                        <h5>Recently Uploaded Images</h5>
                        <div id="uploadedImagesList" style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;"></div>
                    </div>
                </div>
                
                <div id="prizesContainer">
                    <!-- Prize items will be generated here -->
                </div>
                
                <div class="probability-total" id="probabilityTotal">
                    Total Probability: 100%
                </div>
                
                <button class="add-prize" onclick="addNewPrize()">+ Add New Prize</button>
                
                <div class="admin-actions">
                    <button class="save-btn" onclick="savePrizeSettings()">ğŸ’¾ Save & Sync to Firebase</button>
                    <button class="reset-btn" onclick="resetToDefault()">ğŸ”„ Reset to Default</button>
                </div>
            </div>
            
            <!-- Data Export Tab -->
            <div id="export-tab" class="admin-tab-content">
                <h3>Data Export</h3>
                
                <div class="export-section">
                    <h4>Export User Data</h4>
                    <p>Download all user registration data</p>
                    <div class="export-options">
                        <button class="export-btn" onclick="exportUsersToExcel()">ğŸ“Š Export to Excel</button>
                        <button class="export-btn" onclick="exportUsersToCSV()">ğŸ“„ Export to CSV</button>
                    </div>
                    <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                        Total users registered: <span id="adminUserCount">0</span>
                    </p>
                </div>
                
                <div class="export-section">
                    <h4>Export Spin Data</h4>
                    <p>Download all spin history data for analysis</p>
                    <div class="export-options">
                        <button class="export-btn" onclick="exportSpinsToExcel()">ğŸ“Š Export to Excel</button>
                        <button class="export-btn" onclick="exportSpinsToCSV()">ğŸ“„ Export to CSV</button>
                    </div>
                    <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                        Total spins available: <span id="adminSpinCount">0</span>
                    </p>
                </div>
            </div>
            
            <!-- Analytics Tab -->
            <div id="analytics-tab" class="admin-tab-content">
                <h3>Analytics Dashboard</h3>
                
                <div class="status-bar">
                    <strong>Real-time Statistics:</strong><br>
                    ğŸ“Š Total Users: <span id="analyticsUserCount">0</span><br>
                    ğŸ¯ Total Spins: <span id="analyticsSpinCount">0</span><br>
                    ğŸ“ˆ Spins Today: <span id="spinsToday">0</span><br>
                    ğŸ‘¥ Unique Players: <span id="uniquePlayers">0</span>
                </div>
                
                <div class="export-section">
                    <h4>Prize Distribution</h4>
                    <div id="prizeStats">
                        <!-- Prize statistics will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- Live Winners Tab -->
            <div id="winners-tab" class="admin-tab-content">
                <h3>ğŸ† Live Winners Dashboard</h3>
                
                <div class="export-section">
                    <h4>ğŸ¯ Recent Winners</h4>
                    <p>Live updates of all winning spins</p>
                    
                    <!-- Controls -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="export-btn" onclick="refreshWinners()" style="background: #17a2b8;">
                            ğŸ”„ Refresh
                        </button>
                        <button class="export-btn" onclick="clearWinnersDisplay()" style="background: #6c757d;">
                            ğŸ—‘ï¸ Clear Display
                        </button>
                        <button class="export-btn" onclick="exportWinnersToExcel()" style="background: #2ed573;">
                            ğŸ“Š Export Winners
                        </button>
                    </div>
                    
                    <!-- Stats -->
                    <div class="status-bar">
                        <strong>Live Statistics:</strong><br>
                        ğŸ† Total Winners: <span id="totalWinners">0</span><br>
                        ğŸ“ˆ Wins Today: <span id="winsToday">0</span><br>
                        ğŸ”¥ Recent Activity: <span id="recentActivity">0</span> wins in last hour
                    </div>
                    
                    <!-- Winners List -->
                    <div id="winnersList" style="margin-top: 20px; max-height: 400px; overflow-y: auto;">
                        <!-- Winners will be populated here -->
                    </div>
                    
                    <!-- Auto-refresh toggle -->
                    <div style="text-align: center; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <label style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                            <input type="checkbox" id="autoRefresh" onchange="toggleAutoRefresh()">
                            <span>ğŸ”„ Auto-refresh every 30 seconds</span>
                        </label>
                    </div>
                </div>
            </div>
            <!-- Settings Tab -->
            <div id="settings-tab" class="admin-tab-content">
                <h3>System Settings</h3>
                
                <div class="export-section">
                    <h4>Firebase Connection</h4>
                    <div id="adminFirebaseStatus" class="firebase-status status-loading">
                        ğŸ”„ Checking Firebase connection...
                    </div>
                    <button class="export-btn" onclick="testFirebaseConnection()" style="background: #ffa502;">
                        ğŸ”§ Test Firebase Connection
                    </button>
                </div>
                
                <div class="export-section">
                    <h4>Data Management</h4>
                    <button class="export-btn" onclick="clearAllData()" style="background: #ff4757;">
                        ğŸ—‘ï¸ Clear All Data
                    </button>
                    <p style="font-size: 0.8rem; color: #666; margin-top: 10px;">
                        Warning: This will delete all users and spins data.
                    </p>
                </div>
                
            </div>
        </div>
    </div>

    <script>
        // ==================== FIREBASE CONFIGURATION ====================
        const firebaseConfig = {
          apiKey: "AIzaSyCY658zB6ORJJTK-JvPI-L2co9yZnMEPR0",
          authDomain: "fortunewheel-772ab.firebaseapp.com",
          projectId: "fortunewheel-772ab",
          storageBucket: "fortunewheel-772ab.firebasestorage.app",
          messagingSenderId: "539367805663",
          appId: "1:539367805663:web:4ab6dae0a1703bd5674f6a",
          measurementId: "G-8K3KP60744"
        };

        // ==================== FIREBASE INITIALIZATION ====================
        let db = null;
        let firebaseInitialized = false;
        const ADMIN_PASSWORD = "admin123";
        
        // Default prizes with image support
        const defaultPrizes = [
            { name: "Discount 10%", probability: 20, color: "#FF6384", image: "" },
            { name: "Free Coffee", probability: 15, color: "#36A2EB", image: "" },
            { name: "Movie Tickets", probability: 15, color: "#FFCE56", image: "" },
            { name: "Gift Card $25", probability: 10, color: "#4BC0C0", image: "" },
            { name: "Try Again", probability: 25, color: "#9966FF", image: "" },
            { name: "Smartphone", probability: 5, color: "#FF9F40", image: "" },
            { name: "Headphones", probability: 5, color: "#FF6384", image: "" },
            { name: "Amazon Voucher", probability: 5, color: "#C9CBCF", image: "" }
        ];

        let prizes = [];
        let currentUser = null;
        let users = [];
        let spins = [];

        // ==================== IMAGE UPLOAD VARIABLES ====================
        let uploadedImages = JSON.parse(localStorage.getItem('uploadedImages') || '[]');
        let currentlyUploadedImage = null;
        let selectedPrizeIndex = null;

        async function initializeFirebase() {
            try {
                updateFirebaseStatus('loading', 'ğŸ”„ Initializing Firebase...');
                
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                
                // Test connection
                await db.collection('connectionTest').doc('test').set({
                    timestamp: new Date().toISOString()
                });
                
                firebaseInitialized = true;
                updateFirebaseStatus('connected', 'âœ… Firebase Connected');
                
                // Load prizes and data
                await loadPrizesFromFirebase();
                await loadDataFromFirebase();
                
            } catch (error) {
                console.error('Firebase initialization failed:', error);
                firebaseInitialized = false;
                updateFirebaseStatus('error', 'âŒ Firebase Error');
                loadDataFromLocalStorage();
                loadPrizesFromLocalStorage();
            }
        }

        // ==================== PRIZE MANAGEMENT ====================
        async function loadPrizesFromFirebase() {
            try {
                const doc = await db.collection('wheelConfig').doc('prizes').get();
                if (doc.exists) {
                    prizes = doc.data().prizes;
                } else {
                    prizes = [...defaultPrizes];
                    await savePrizesToFirebase();
                }
                createWheelSegments();
            } catch (error) {
                console.error('Error loading prizes from Firebase:', error);
                loadPrizesFromLocalStorage();
            }
        }

        function loadPrizesFromLocalStorage() {
            const savedPrizes = localStorage.getItem('wheelPrizes');
            prizes = savedPrizes ? JSON.parse(savedPrizes) : [...defaultPrizes];
            createWheelSegments();
        }

        async function savePrizesToFirebase() {
            try {
                if (firebaseInitialized) {
                    await db.collection('wheelConfig').doc('prizes').set({
                        prizes: prizes,
                        lastUpdated: new Date().toISOString()
                    });
                }
            } catch (error) {
                console.error('Error saving prizes to Firebase:', error);
            }
            localStorage.setItem('wheelPrizes', JSON.stringify(prizes));
        }

        function renderPrizeControls() {
            const container = document.getElementById('prizesContainer');
            container.innerHTML = '';
            
            let totalProbability = 0;
            
            prizes.forEach((prize, index) => {
                totalProbability += prize.probability;
                
                const prizeItem = document.createElement('div');
                prizeItem.className = 'prize-item';
                prizeItem.innerHTML = `
                    <div class="prize-color" style="background-color: ${prize.color}" title="Click color picker to change"></div>
                    <div class="prize-inputs">
                        <input type="text" class="prize-name" value="${prize.name}" placeholder="Prize Name">
                        <input type="number" class="prize-probability" value="${prize.probability}" min="1" max="100" placeholder="%">
                        <input type="color" class="prize-color-input" value="${prize.color}">
                        <div class="prize-image-input-container">
                            <input type="url" class="prize-image-input" value="${prize.image || ''}" placeholder="Image URL">
                            <button type="button" class="export-btn" onclick="selectPrizeForUpload(${index})" style="padding: 8px 12px; background: #17a2b8; white-space: nowrap;">
                                ğŸ“·
                            </button>
                        </div>
                        <button class="remove-prize" onclick="removePrize(${index})" title="Remove Prize">Ã—</button>
                    </div>
                `;
                container.appendChild(prizeItem);
            });
            
            // Update probability display with color coding
            const probabilityElement = document.getElementById('probabilityTotal');
            probabilityElement.textContent = `Total Probability: ${totalProbability}%`;
            probabilityElement.style.background = totalProbability === 100 
                ? 'linear-gradient(135deg, #2ed573 0%, #1dd1a1 100%)'
                : 'linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%)';
            
            // Add event listeners
            container.querySelectorAll('.prize-name, .prize-probability, .prize-color-input, .prize-image-input').forEach(input => {
                input.addEventListener('input', updatePrizeFromInputs);
            });
        }

        function updatePrizeFromInputs() {
            const prizeItems = document.querySelectorAll('.prize-item');
            let totalProbability = 0;
            
            prizeItems.forEach((item, index) => {
                const name = item.querySelector('.prize-name').value;
                const probability = parseInt(item.querySelector('.prize-probability').value) || 0;
                const color = item.querySelector('.prize-color-input').value;
                const image = item.querySelector('.prize-image-input').value;
                
                prizes[index] = { name, probability, color, image };
                totalProbability += probability;
                
                item.querySelector('.prize-color').style.backgroundColor = color;
                
                // Update image preview
                const preview = item.querySelector('.preview-small');
                if (preview && image) {
                    preview.src = image;
                    preview.style.display = 'block';
                } else if (preview) {
                    preview.style.display = 'none';
                }
            });
            
            document.getElementById('probabilityTotal').textContent = `Total Probability: ${totalProbability}%`;
            document.getElementById('probabilityTotal').style.color = totalProbability === 100 ? 'green' : 'red';
        }

        function addNewPrize() {
            prizes.push({
                name: "New Prize",
                probability: 10,
                color: "#" + Math.floor(Math.random()*16777215).toString(16),
                image: ""
            });
            renderPrizeControls();
        }

        function removePrize(index) {
            prizes.splice(index, 1);
            renderPrizeControls();
        }

        function savePrizeSettings() {
            updatePrizeFromInputs();
            const totalProbability = prizes.reduce((sum, p) => sum + p.probability, 0);
            
            if (totalProbability !== 100) {
                alert(`Total probability must be 100%. Current total: ${totalProbability}%`);
                return;
            }
            
            savePrizesToFirebase();
            createWheelSegments();
            alert('Prizes saved successfully!');
        }

        function resetToDefault() {
            if (confirm('Are you sure you want to reset to default prizes?')) {
                prizes = [...defaultPrizes];
                savePrizesToFirebase();
                renderPrizeControls();
                createWheelSegments();
            }
        }

        // ==================== WHEEL DISPLAY FUNCTIONS ====================
        function createWheelSegments() {
        const wheel = document.getElementById('wheel');
        wheel.innerHTML = '';
        
        const numberOfSegments = prizes.length;
        const segmentAngle = 360 / numberOfSegments;
        
        // Create conic gradient for the wheel background
        const conicGradient = [];
        prizes.forEach((prize, index) => {
            const startAngle = index * segmentAngle;
            const endAngle = (index + 1) * segmentAngle;
            conicGradient.push(`${prize.color} ${startAngle}deg ${endAngle}deg`);
        });
        
        wheel.style.background = `conic-gradient(${conicGradient.join(', ')})`;
        
        // Create individual segments with ONLY ICONS (no text at all)
        prizes.forEach((prize, index) => {
            const segment = document.createElement('div');
            segment.className = 'wheel-segment';
            
            const angle = index * segmentAngle;
            segment.style.transform = `rotate(${angle}deg)`;
            
            // Create image container - ONLY SHOW ICONS, NO TEXT
            const imageContainer = document.createElement('div');
            imageContainer.className = 'segment-image';
            
            // Use prize image or show nothing (empty segment)
            if (prize.image) {
                imageContainer.innerHTML = `
                    <img src="${prize.image}" alt="${prize.name}" 
                        onerror="this.style.display='none'">
                `;
            } else {
                // If no image, show empty segment (no text)
                imageContainer.innerHTML = '';
            }
            
            segment.appendChild(imageContainer);
            wheel.appendChild(segment);
        });
        
        console.log('Wheel created with', prizes.length, 'segments (icons only, no text)');
    }

        // Helper function to ensure text is readable on any background
        function getContrastColor(hexcolor) {
            const r = parseInt(hexcolor.substr(1, 2), 16);
            const g = parseInt(hexcolor.substr(3, 2), 16);
            const b = parseInt(hexcolor.substr(5, 2), 16);
            const brightness = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            return brightness > 128 ? 'black' : 'white';
        }

        // ==================== IMAGE UPLOAD FUNCTIONALITY ====================
        function initializeImageUpload() {
            const imageUpload = document.getElementById('imageUpload');
            if (imageUpload) {
                imageUpload.addEventListener('change', handleImageUpload);
            }
            loadUploadedImagesGallery();
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Check file type
            if (!file.type.startsWith('image/')) {
                alert('Please select a valid image file (JPEG, PNG, GIF, etc.)');
                return;
            }

            // Check file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                alert('Image size should be less than 2MB');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                currentlyUploadedImage = e.target.result;
                
                // Show preview
                const preview = document.getElementById('previewImage');
                const uploadPreview = document.getElementById('uploadPreview');
                
                preview.src = currentlyUploadedImage;
                uploadPreview.style.display = 'block';
                
                // Scroll to preview
                uploadPreview.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            };
            reader.readAsDataURL(file);
        }

        function clearImageUpload() {
            document.getElementById('imageUpload').value = '';
            document.getElementById('uploadPreview').style.display = 'none';
            currentlyUploadedImage = null;
        }

        function useUploadedImage() {
            if (!currentlyUploadedImage) {
                alert('Please upload an image first');
                return;
            }

            // If a prize is selected in the form, use it
            const activeInput = document.querySelector('.prize-image-input:focus');
            if (activeInput) {
                const index = Array.from(document.querySelectorAll('.prize-image-input')).indexOf(activeInput);
                if (index !== -1) {
                    setImageForPrize(index, currentlyUploadedImage);
                    return;
                }
            }

            // Otherwise, ask which prize to apply to
            const prizeNames = prizes.map((prize, index) => `${index + 1}. ${prize.name}`).join('\n');
            const prizeNumber = prompt(`Which prize would you like to assign this image to?\n\n${prizeNames}\n\nEnter the number (1-${prizes.length}):`);
            
            const index = parseInt(prizeNumber) - 1;
            if (index >= 0 && index < prizes.length) {
                setImageForPrize(index, currentlyUploadedImage);
            } else {
                alert('Invalid prize number selected');
            }
        }

        function setImageForPrize(index, imageData) {
            prizes[index].image = imageData;
            
            // Update the input field
            const imageInputs = document.querySelectorAll('.prize-image-input');
            if (imageInputs[index]) {
                imageInputs[index].value = imageData;
            }
            
            // Update preview
            const previews = document.querySelectorAll('.preview-small');
            if (previews[index]) {
                previews[index].src = imageData;
                previews[index].style.display = 'block';
            }
            
            // Save to uploaded images gallery
            saveToUploadedImages(imageData);
            
            // Clear upload
            clearImageUpload();
            
            alert(`Image assigned to "${prizes[index].name}" successfully!`);
        }

        function saveToUploadedImages(imageData) {
            // Check if image already exists
            if (!uploadedImages.includes(imageData)) {
                uploadedImages.unshift(imageData); // Add to beginning
                // Keep only last 20 images
                if (uploadedImages.length > 20) {
                    uploadedImages = uploadedImages.slice(0, 20);
                }
                localStorage.setItem('uploadedImages', JSON.stringify(uploadedImages));
                loadUploadedImagesGallery();
            }
        }

        function loadUploadedImagesGallery() {
            const gallery = document.getElementById('uploadedImagesGallery');
            const list = document.getElementById('uploadedImagesList');
            
            if (uploadedImages.length === 0) {
                gallery.style.display = 'none';
                return;
            }
            
            gallery.style.display = 'block';
            list.innerHTML = '';
            
            uploadedImages.forEach((imageData, index) => {
                const imageItem = document.createElement('div');
                imageItem.className = 'uploaded-image-item';
                imageItem.innerHTML = `
                    <img src="${imageData}" alt="Uploaded image ${index + 1}" onclick="selectUploadedImage(this)">
                    <button class="delete-uploaded-image" onclick="deleteUploadedImage(${index})">Ã—</button>
                `;
                list.appendChild(imageItem);
            });
        }

        function selectUploadedImage(imgElement) {
            currentlyUploadedImage = imgElement.src;
            
            // Show preview
            const preview = document.getElementById('previewImage');
            const uploadPreview = document.getElementById('uploadPreview');
            
            preview.src = currentlyUploadedImage;
            uploadPreview.style.display = 'block';
            
            // Highlight selected image
            document.querySelectorAll('.uploaded-image-item').forEach(item => {
                item.classList.remove('selected');
            });
            imgElement.parentElement.classList.add('selected');
        }

        function deleteUploadedImage(index) {
            if (confirm('Are you sure you want to delete this image from your gallery?')) {
                uploadedImages.splice(index, 1);
                localStorage.setItem('uploadedImages', JSON.stringify(uploadedImages));
                loadUploadedImagesGallery();
                
                // Also remove this image from any prizes using it
                const deletedImage = uploadedImages[index];
                prizes.forEach((prize, prizeIndex) => {
                    if (prize.image === deletedImage) {
                        prize.image = '';
                        // Clear the input field if it exists
                        const imageInputs = document.querySelectorAll('.prize-image-input');
                        if (imageInputs[prizeIndex]) {
                            imageInputs[prizeIndex].value = '';
                        }
                    }
                });
            }
        }

        function selectPrizeForUpload(index) {
            selectedPrizeIndex = index;
            document.getElementById('imageUpload').click();
        }

        // ==================== DATA MANAGEMENT ====================
        async function loadDataFromFirebase() {
            try {
                // Check if we have a "dataCleared" flag in localStorage
                const dataCleared = localStorage.getItem('dataCleared');
                if (dataCleared) {
                    console.log('Data was recently cleared, skipping Firebase load');
                    localStorage.removeItem('dataCleared'); // Remove the flag
                    loadDataFromLocalStorage();
                    return;
                }

                // Load users
                const usersSnapshot = await db.collection('users').get();
                users = [];
                usersSnapshot.forEach(doc => {
                    users.push({ id: doc.id, ...doc.data() });
                });
                
                // Load spins
                const spinsSnapshot = await db.collection('spins').get();
                spins = [];
                spinsSnapshot.forEach(doc => {
                    spins.push({ id: doc.id, ...doc.data() });
                });
                
                updateCounts();
                updateAnalytics();
                
            } catch (error) {
                console.error('Error loading from Firebase:', error);
                loadDataFromLocalStorage();
            }
        }

        function loadDataFromLocalStorage() {
            const savedUsers = localStorage.getItem('wheelUsers');
            users = savedUsers ? JSON.parse(savedUsers) : [];
            
            const savedSpins = localStorage.getItem('wheelSpins');
            spins = savedSpins ? JSON.parse(savedSpins) : [];
            
            updateCounts();
            updateAnalytics();
        }

        async function saveUserToFirebase(user) {
            try {
                if (firebaseInitialized) {
                    const userData = {
                        name: user.name,
                        email: user.email,
                        phone: user.phone,
                        company: user.company || 'Not provided',
                        registrationDate: new Date().toLocaleDateString(),
                        registrationTime: new Date().toLocaleTimeString(),
                        timestamp: new Date().toISOString()
                    };
                    
                    await db.collection('users').add(userData);
                }
            } catch (error) {
                console.error('Error saving user to Firebase:', error);
            }
            
            saveUserToLocalStorage(user);
        }

        async function saveSpinToFirebase(prize, user) {
            try {
                if (firebaseInitialized) {
                    const spinData = {
                        prize: prize.name,
                        prizeImage: prize.image,
                        userEmail: user ? user.email : 'Guest',
                        userName: user ? user.name : 'Guest',
                        userPhone: user ? user.phone : 'N/A',
                        userCompany: user ? user.company : 'N/A',
                        timestamp: new Date().toISOString(),
                        date: new Date().toLocaleDateString(),
                        time: new Date().toLocaleTimeString()
                    };
                    
                    await db.collection('spins').add(spinData);
                }
            } catch (error) {
                console.error('Error saving spin to Firebase:', error);
            }
            
            saveSpinToLocalStorage(prize, user);
        }

        function saveUserToLocalStorage(user) {
            const existingIndex = users.findIndex(u => u.email === user.email);
            if (existingIndex === -1) {
                users.push(user);
            } else {
                users[existingIndex] = user;
            }
            localStorage.setItem('wheelUsers', JSON.stringify(users));
            localStorage.setItem('currentUser', JSON.stringify(user));
            updateCounts();
            updateAnalytics();
        }

        function saveSpinToLocalStorage(prize, user) {
            const spin = {
                id: Date.now().toString(),
                prize: prize.name,
                prizeImage: prize.image,
                userEmail: user ? user.email : 'Guest',
                userName: user ? user.name : 'Guest',
                userPhone: user ? user.phone : 'N/A',
                userCompany: user ? user.company : 'N/A',
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString()
            };
            
            spins.push(spin);
            localStorage.setItem('wheelSpins', JSON.stringify(spins));
            updateCounts();
            updateAnalytics();
        }

        // ==================== UI FUNCTIONS ====================
        function updateFirebaseStatus(status, message) {
            const elements = ['firebaseStatus', 'gameFirebaseStatus', 'adminFirebaseStatus'];
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = message;
                    element.className = `firebase-status status-${status}`;
                }
            });
        }

        function updateCounts() {
            document.getElementById('userCount').textContent = users.length;
            document.getElementById('spinCount').textContent = spins.length;
            document.getElementById('adminUserCount').textContent = users.length;
            document.getElementById('adminSpinCount').textContent = spins.length;
        }

        function updateAnalytics() {
            document.getElementById('analyticsUserCount').textContent = users.length;
            document.getElementById('analyticsSpinCount').textContent = spins.length;
            
            // Calculate spins today
            const today = new Date().toDateString();
            const spinsToday = spins.filter(spin => new Date(spin.timestamp).toDateString() === today).length;
            document.getElementById('spinsToday').textContent = spinsToday;
            
            // Calculate unique players
            const uniqueEmails = new Set(spins.map(spin => spin.userEmail));
            document.getElementById('uniquePlayers').textContent = uniqueEmails.size;
            
            // Prize distribution
            const prizeStats = document.getElementById('prizeStats');
            if (prizeStats) {
                const distribution = {};
                spins.forEach(spin => {
                    distribution[spin.prize] = (distribution[spin.prize] || 0) + 1;
                });
                
                prizeStats.innerHTML = Object.entries(distribution)
                    .map(([prize, count]) => `
                        <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee;">
                            <span>${prize}</span>
                            <span style="font-weight: bold;">${count} (${((count/spins.length)*100).toFixed(1)}%)</span>
                        </div>
                    `).join('');
            }
        }

        // ==================== APPLICATION INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase().then(() => {
                createWheelSegments();
                
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    showWheelGame();
                }
            });

            document.getElementById('userForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                currentUser = {
                    id: Date.now().toString(),
                    name: formData.get('name'),
                    phone: formData.get('phone'),
                    email: formData.get('email'),
                    company: formData.get('company') || 'Not provided',
                    registrationDate: new Date().toLocaleDateString(),
                    registrationTime: new Date().toLocaleTimeString(),
                    timestamp: new Date().toISOString()
                };

                await saveUserToFirebase(currentUser);
                showWheelGame();
            });

            document.getElementById('spinBtn').addEventListener('click', spinWheel);
        });

        function showWheelGame() {
            document.getElementById('registrationForm').style.display = 'none';
            document.getElementById('wheelGame').style.display = 'block';
            
            if (currentUser) {
                document.getElementById('userDetails').innerHTML = `
                    <strong>Name:</strong> ${currentUser.name}<br>
                    <strong>Phone:</strong> ${currentUser.phone}<br>
                    <strong>Email:</strong> ${currentUser.email}
                    ${currentUser.company ? `<br><strong>Company:</strong> ${currentUser.company}` : ''}
                    <br><br>
                    <button class="switch-user-btn" onclick="switchUser()">
                        ğŸ”„ Register New User
                    </button>
                `;
            }
        }

        async function spinWheel() {
            const spinBtn = document.getElementById('spinBtn');
            const wheel = document.getElementById('wheel');
            const prizeText = document.getElementById('prizeText');
            
            spinBtn.disabled = true;
            spinBtn.textContent = "Spinning...";
            wheel.style.transition = 'none';
            wheel.style.transform = 'rotate(0deg)';
            void wheel.offsetWidth;

            // Determine prize based on probability
            const randomValue = Math.random() * 100;
            let cumulativeProbability = 0;
            let selectedPrizeIndex = 0;
            
            for (let i = 0; i < prizes.length; i++) {
                cumulativeProbability += prizes[i].probability;
                if (randomValue <= cumulativeProbability) {
                    selectedPrizeIndex = i;
                    break;
                }
            }

            // Calculate rotation (5 full rotations + offset to land on selected prize)
            const fullRotations = 5;
            const segmentAngle = 360 / prizes.length;
            const selectedSegmentMiddle = selectedPrizeIndex * segmentAngle + (segmentAngle / 2);
            const finalRotation = fullRotations * 360 + (360 - selectedSegmentMiddle);
            
            // Add some random variation for natural feel
            const randomVariation = (Math.random() - 0.5) * (segmentAngle * 0.8);
            const finalRotationWithVariation = finalRotation + randomVariation;
            
            wheel.style.transition = 'transform 4s cubic-bezier(0.17, 0.67, 0.83, 0.67)';
            wheel.style.transform = `rotate(${finalRotationWithVariation}deg)`;

            setTimeout(async function() {
                const actualPrize = prizes[selectedPrizeIndex];
                
                // Display BOTH icon and text in the result panel
                if (actualPrize.image) {
                    prizeText.innerHTML = `
                        <img src="${actualPrize.image}" alt="${actualPrize.name}" class="prize-icon">
                        ${actualPrize.name}
                    `;
                } else {
                    prizeText.innerHTML = actualPrize.name;
                }
                
                prizeText.parentElement.classList.add('celebrate');
                
                await saveSpinToFirebase(actualPrize, currentUser);
                
                // Re-enable spin button but change text to indicate multiple spins are allowed
                spinBtn.disabled = false;
                spinBtn.textContent = "SPIN AGAIN";
                
                setTimeout(() => prizeText.parentElement.classList.remove('celebrate'), 1500);
            }, 4000);
        }

        // ==================== LIVE WINNERS FUNCTIONS ====================
        let autoRefreshInterval = null;
        let lastRefreshTime = null;

        function refreshWinners() {
            updateWinnersDisplay();
            lastRefreshTime = new Date();
            document.getElementById('recentActivity').textContent = getRecentWinsCount();
        }

        function clearWinnersDisplay() {
            if (confirm('Clear the winners display? This won\'t delete data, just clear the view.')) {
                const winnersList = document.getElementById('winnersList');
                winnersList.innerHTML = '<div class="empty-winners">ğŸ¯ No winners to display yet</div>';
                updateWinnersStats();
            }
        }

        function toggleAutoRefresh() {
            const autoRefreshCheckbox = document.getElementById('autoRefresh');
            
            if (autoRefreshCheckbox.checked) {
                autoRefreshInterval = setInterval(refreshWinners, 30000); // 30 seconds
                console.log('Auto-refresh enabled');
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                console.log('Auto-refresh disabled');
            }
        }

        function updateWinnersDisplay() {
            const winnersList = document.getElementById('winnersList');
            
            if (spins.length === 0) {
                winnersList.innerHTML = '<div class="empty-winners">ğŸ¯ No winners to display yet</div>';
                return;
            }
            
            // Sort spins by timestamp (newest first)
            const sortedSpins = [...spins].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            let html = '';
            let count = 0;
            
            sortedSpins.forEach((spin, index) => {
                if (count >= 50) return; // Limit to 50 most recent
                
                const spinTime = new Date(spin.timestamp);
                const timeAgo = getTimeAgo(spinTime);
                const isNew = lastRefreshTime && spinTime > lastRefreshTime;
                
                html += `
                    <div class="winner-item ${isNew ? 'new' : ''}">
                        <div class="winner-prize-icon">
                            ${spin.prizeImage ? 
                                `<img src="${spin.prizeImage}" alt="${spin.prize}" style="width: 100%; height: 100%; object-fit: contain;">` :
                                'ğŸ'
                            }
                        </div>
                        <div class="winner-details">
                            <div class="winner-name">${spin.userName}</div>
                            <div class="winner-prize">${spin.prize}</div>
                            <div class="winner-meta">
                                <span class="winner-time">${timeAgo}</span>
                                ${spin.userCompany && spin.userCompany !== 'N/A' ? 
                                    `<span class="winner-company">${spin.userCompany}</span>` : ''
                                }
                                <span>ğŸ“§ ${spin.userEmail}</span>
                                ${spin.userPhone && spin.userPhone !== 'N/A' ? 
                                    `<span>ğŸ“ ${spin.userPhone}</span>` : ''
                                }
                            </div>
                        </div>
                        ${isNew ? '<div style="color: #ffa502; font-weight: bold;">NEW!</div>' : ''}
                    </div>
                `;
                count++;
            });
            
            winnersList.innerHTML = html;
            updateWinnersStats();
        }

        function updateWinnersStats() {
            // Total winners
            document.getElementById('totalWinners').textContent = spins.length;
            
            // Wins today
            const today = new Date().toDateString();
            const winsToday = spins.filter(spin => new Date(spin.timestamp).toDateString() === today).length;
            document.getElementById('winsToday').textContent = winsToday;
            
            // Recent activity (last hour)
            document.getElementById('recentActivity').textContent = getRecentWinsCount();
        }

        function getRecentWinsCount() {
            const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
            return spins.filter(spin => new Date(spin.timestamp) > oneHourAgo).length;
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            return `${Math.floor(diffInSeconds / 86400)}d ago`;
        }

        function exportWinnersToExcel() {
            if (spins.length === 0) {
                alert('No winner data available to export.');
                return;
            }

            const winnersData = spins.map(spin => ({
                'Winner Name': spin.userName,
                'Prize': spin.prize,
                'Email': spin.userEmail,
                'Phone': spin.userPhone,
                'Company': spin.userCompany,
                'Date': spin.date,
                'Time': spin.time,
                'Timestamp': spin.timestamp
            }));

            try {
                const worksheet = XLSX.utils.json_to_sheet(winnersData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Winners');
                XLSX.writeFile(workbook, `wheel_winners_${new Date().toISOString().split('T')[0]}.xlsx`);
                alert(`Successfully exported ${spins.length} winners to Excel!`);
            } catch (error) {
                alert('Error exporting winners to Excel: ' + error.message);
            }
        }

        // Update the switchAdminTab function
        function switchAdminTab(tabName) {
            document.querySelectorAll('.admin-tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.admin-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'analytics') {
                updateAnalytics();
            } else if (tabName === 'winners') {
                refreshWinners();
            }
        }

        // Update the saveSpin functions to refresh winners display
       async function saveSpinToFirebase(prize, user) {
            try {
                if (firebaseInitialized) {
                    const spinData = {
                        prize: prize.name,
                        prizeImage: prize.image,
                        userEmail: user ? user.email : 'Guest',
                        userName: user ? user.name : 'Guest',
                        userPhone: user ? user.phone : 'N/A',
                        userCompany: user ? user.company : 'N/A',
                        timestamp: new Date().toISOString(),
                        date: new Date().toLocaleDateString(),
                        time: new Date().toLocaleTimeString()
                    };
                    
                    await db.collection('spins').add(spinData);
                }
            } catch (error) {
                console.error('Error saving spin to Firebase:', error);
            }
            
            saveSpinToLocalStorage(prize, user);
            // Refresh winners display if it's visible
            if (document.getElementById('winners-tab').classList.contains('active')) {
                refreshWinners();
            }
        }

        // ==================== USER SWITCHING FUNCTIONS ====================
        function switchUser() {
            if (confirm('Are you sure you want to register a new user? Current user data will be cleared.')) {
                // Clear current user data
                currentUser = null;
                localStorage.removeItem('currentUser');
                
                // Reset UI
                document.getElementById('prizeText').textContent = '-';
                const wheel = document.getElementById('wheel');
                wheel.style.transition = 'none';
                wheel.style.transform = 'rotate(0deg)';
                
                // Reset spin button
                const spinBtn = document.getElementById('spinBtn');
                spinBtn.disabled = false;
                spinBtn.textContent = "SPIN THE WHEEL";
                
                // Show registration form
                document.getElementById('registrationForm').style.display = 'block';
                document.getElementById('wheelGame').style.display = 'none';
                document.getElementById('userForm').reset();
                
                alert('You can now register a new user.');
            }
        }

        function newSpin() {
            // Reset the wheel and prize display for a new spin
            document.getElementById('prizeText').textContent = '-';
            const wheel = document.getElementById('wheel');
            wheel.style.transition = 'none';
            wheel.style.transform = 'rotate(0deg)';
            
            // Re-enable spin button if it was disabled
            const spinBtn = document.getElementById('spinBtn');
            spinBtn.disabled = false;
            spinBtn.textContent = "SPIN THE WHEEL";
            
            alert('Ready for a new spin! Click "SPIN THE WHEEL" to try again.');
        }

        // ==================== ADMIN PANEL FUNCTIONS ====================
        function showPasswordPanel() {
            document.getElementById('passwordPanel').style.display = 'flex';
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordError').style.display = 'none';
        }

        function checkPassword() {
            const password = document.getElementById('passwordInput').value;
            if (password === ADMIN_PASSWORD) {
                document.getElementById('passwordPanel').style.display = 'none';
                showAdminPanel();
            } else {
                document.getElementById('passwordError').style.display = 'block';
            }
        }

        function showAdminPanel() {
            updateCounts();
            updateAnalytics();
            renderPrizeControls();
            document.getElementById('adminPanel').style.display = 'flex';
            
            // Initialize image upload functionality
            initializeImageUpload();
            
            // Ensure only the prizes tab is active initially
            switchAdminTab('prizes');
        }

        function hideAdminPanel() {
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('passwordPanel').style.display = 'none';
        }

        function switchAdminTab(tabName) {
            document.querySelectorAll('.admin-tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.admin-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'analytics') {
                updateAnalytics();
            }
        }

        async function testFirebaseConnection() {
            try {
                updateFirebaseStatus('loading', 'ğŸ”„ Testing Firebase Connection...');
                await db.collection('connectionTest').doc('test').set({ timestamp: new Date().toISOString() });
                updateFirebaseStatus('connected', 'âœ… Firebase Connection Test Successful!');
                alert('Firebase connection test successful!');
            } catch (error) {
                updateFirebaseStatus('error', 'âŒ Connection Test Failed');
                alert('Connection test failed: ' + error.message);
            }
        }

        async function clearAllData() {
            if (confirm('Are you sure you want to clear ALL data? This cannot be undone.')) {
                try {
                    // Clear Firebase data if connected
                    if (firebaseInitialized) {
                        // Clear users from Firebase
                        const usersSnapshot = await db.collection('users').get();
                        const userDeletePromises = usersSnapshot.docs.map(doc => doc.ref.delete());
                        
                        // Clear spins from Firebase
                        const spinsSnapshot = await db.collection('spins').get();
                        const spinDeletePromises = spinsSnapshot.docs.map(doc => doc.ref.delete());
                        
                        await Promise.all([...userDeletePromises, ...spinDeletePromises]);
                        console.log('Firebase data cleared successfully');
                    }
                } catch (error) {
                    console.error('Error clearing Firebase data:', error);
                }
                
                // Clear localStorage
                users = [];
                spins = [];
                localStorage.removeItem('wheelUsers');
                localStorage.removeItem('wheelSpins');
                localStorage.removeItem('currentUser');
                localStorage.removeItem('uploadedImages');
                uploadedImages = [];
                
                // Set flag to prevent Firebase from reloading data on next refresh
                localStorage.setItem('dataCleared', 'true');
                
                updateCounts();
                updateAnalytics();
                alert('All data has been cleared from both Firebase and local storage.');
            }
        }

        // ==================== EXPORT FUNCTIONS ====================
        function exportUsersToExcel() {
            if (users.length === 0) {
                alert('No user data available to export.');
                return;
            }

            const usersData = users.map(user => ({
                'Name': user.name,
                'Email': user.email,
                'Phone': user.phone,
                'Company': user.company,
                'Registration Date': user.registrationDate,
                'Registration Time': user.registrationTime
            }));

            try {
                const worksheet = XLSX.utils.json_to_sheet(usersData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Users');
                XLSX.writeFile(workbook, `wheel_users_${new Date().toISOString().split('T')[0]}.xlsx`);
                alert(`Successfully exported ${users.length} users to Excel!`);
            } catch (error) {
                alert('Error exporting to Excel: ' + error.message);
            }
        }

        function exportSpinsToExcel() {
            if (spins.length === 0) {
                alert('No spin data available to export.');
                return;
            }

            const spinsData = spins.map(spin => ({
                'Prize': spin.prize,
                'User Name': spin.userName,
                'User Email': spin.userEmail,
                'User Phone': spin.userPhone,
                'Company': spin.userCompany,
                'Date': spin.date,
                'Time': spin.time
            }));

            try {
                const worksheet = XLSX.utils.json_to_sheet(spinsData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Spins');
                XLSX.writeFile(workbook, `wheel_spins_${new Date().toISOString().split('T')[0]}.xlsx`);
                alert(`Successfully exported ${spins.length} spins to Excel!`);
            } catch (error) {
                alert('Error exporting to Excel: ' + error.message);
            }
        }

        function exportUsersToCSV() {
            if (users.length === 0) {
                alert('No user data available to export.');
                return;
            }

            const usersData = users.map(user => ({
                'Name': user.name,
                'Email': user.email,
                'Phone': user.phone,
                'Company': user.company,
                'Registration Date': user.registrationDate,
                'Registration Time': user.registrationTime
            }));

            try {
                const worksheet = XLSX.utils.json_to_sheet(usersData);
                const csv = XLSX.utils.sheet_to_csv(worksheet);
                downloadCSV(csv, `wheel_users_${new Date().toISOString().split('T')[0]}.csv`);
                alert(`Successfully exported ${users.length} users to CSV!`);
            } catch (error) {
                alert('Error exporting to CSV: ' + error.message);
            }
        }

        function exportSpinsToCSV() {
            if (spins.length === 0) {
                alert('No spin data available to export.');
                return;
            }

            const spinsData = spins.map(spin => ({
                'Prize': spin.prize,
                'User Name': spin.userName,
                'User Email': spin.userEmail,
                'User Phone': spin.userPhone,
                'Company': spin.userCompany,
                'Date': spin.date,
                'Time': spin.time
            }));

            try {
                const worksheet = XLSX.utils.json_to_sheet(spinsData);
                const csv = XLSX.utils.sheet_to_csv(worksheet);
                downloadCSV(csv, `wheel_spins_${new Date().toISOString().split('T')[0]}.csv`);
                alert(`Successfully exported ${spins.length} spins to CSV!`);
            } catch (error) {
                alert('Error exporting to CSV: ' + error.message);
            }
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Close panels when clicking outside
        document.getElementById('adminPanel').addEventListener('click', function(event) {
            if (event.target === this) hideAdminPanel();
        });
        
        document.getElementById('passwordPanel').addEventListener('click', function(event) {
            if (event.target === this) hideAdminPanel();
        });
    </script>
</body>
</html>
