<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lucky Spin Wheel - Complete Admin</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            max-width: 500px;
            width: 100%;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(to right, #ff7e5f, #feb47b);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .content {
            padding: 30px;
        }
        
        .registration-form {
            width: 100%;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .form-group input:focus {
            border-color: #ff7e5f;
            outline: none;
        }
        
        .submit-btn {
            background: linear-gradient(to right, #ff7e5f, #feb47b);
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 50px;
            font-size: 1.3rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        
        .wheel-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto 30px auto;
        }
        
        .wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            transition: transform 4s cubic-bezier(0.17, 0.67, 0.83, 0.67);
            box-shadow: 0 0 0 10px white, 0 0 20px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .wheel-segment {
            position: absolute;
            width: 50%;
            height: 50%;
            left: 50%;
            top: 0;
            transform-origin: left bottom;
            overflow: hidden;
        }
        
        .segment-text {
            position: absolute;
            left: 20px;
            top: 10%;
            transform: translateY(-50%) rotate(90deg);
            transform-origin: left center;
            text-align: center;
            width: 120px;
            font-size: 11px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            line-height: 1.2;
        }
        
        .wheel-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background-color: white;
            border-radius: 50%;
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            border: 4px solid #ff7e5f;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }
        
        .wheel-pointer {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 40px;
            background-color: #ff7e5f;
            clip-path: polygon(50% 100%, 0 0, 100% 0);
            z-index: 20;
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3));
        }
        
        .btn-spin {
            background: linear-gradient(to right, #ff7e5f, #feb47b);
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 50px;
            font-size: 1.3rem;
            font-weight: 600;
            cursor: pointer;
            display: block;
            margin: 0 auto 20px auto;
            box-shadow: 0 5px 15px rgba(255, 126, 95, 0.4);
            transition: all 0.3s;
        }
        
        .btn-spin:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 126, 95, 0.6);
        }
        
        .btn-spin:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .result {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 10px;
        }
        
        .prize-text {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ff7e5f;
        }
        
        .user-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .admin-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .admin-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .admin-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            flex-wrap: wrap;
        }
        
        .admin-tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .admin-tab.active {
            color: #ff7e5f;
            border-bottom-color: #ff7e5f;
        }
        
        .admin-tab-content {
            display: none;
        }
        
        .admin-tab-content.active {
            display: block;
        }
        
        .export-btn {
            background: #2ed573;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            transition: all 0.3s;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .status-bar {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 0.9rem;
        }
        
        .firebase-status {
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin: 10px 0;
            text-align: center;
        }
        
        .status-connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        /* Prize Management Styles */
        .prize-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .prize-color {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 15px;
            border: 2px solid #ddd;
        }
        
        .prize-inputs {
            flex: 1;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .prize-inputs input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .prize-name {
            flex: 2;
        }
        
        .prize-probability {
            flex: 1;
            max-width: 80px;
        }
        
        .prize-color-input {
            flex: 0.5;
            max-width: 60px;
            height: 40px;
            padding: 0;
            border: none;
        }
        
        .remove-prize {
            background: #ff4757;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .add-prize {
            background: #2ed573;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 15px;
            width: 100%;
        }
        
        .admin-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .save-btn {
            background: #3742fa;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            flex: 1;
        }
        
        .reset-btn {
            background: #ffa502;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            flex: 1;
        }
        
        .probability-total {
            text-align: center;
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .probability-info {
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 5px;
            font-size: 0.9rem;
            color: #1565c0;
        }

        .export-options {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .export-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .bottom-admin-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #2c3e50;
            color: white;
            padding: 15px;
            text-align: center;
            z-index: 999;
        }
        
        .bottom-admin-btn {
            background: linear-gradient(to right, #ff7e5f, #feb47b);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(255, 126, 95, 0.4);
            transition: all 0.3s;
        }

        .bottom-admin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 126, 95, 0.6);
        }

        @keyframes celebrate {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .celebrate {
            animation: celebrate 0.5s ease-in-out 3;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Lucky Spin Wheel</h1>
            <p>Spin to win amazing prizes!</p>
        </div>
        
        <div class="content">
            <div class="registration-form" id="registrationForm">
                <h2 style="text-align: center; margin-bottom: 20px; color: #333;">Enter Your Details</h2>
                
                <div id="firebaseStatus" class="firebase-status status-loading">
                    🔄 Initializing Firebase...
                </div>
                
                <form id="userForm">
                    <div class="form-group">
                        <label for="userName">Full Name *</label>
                        <input type="text" id="userName" name="name" required placeholder="Enter your full name">
                    </div>
                    
                    <div class="form-group">
                        <label for="userPhone">Phone Number *</label>
                        <input type="tel" id="userPhone" name="phone" required placeholder="Enter your phone number">
                    </div>
                    
                    <div class="form-group">
                        <label for="userEmail">Email Address *</label>
                        <input type="email" id="userEmail" name="email" required placeholder="Enter your email address">
                    </div>
                    
                    <div class="form-group">
                        <label for="userCompany">Company (Optional)</label>
                        <input type="text" id="userCompany" name="company" placeholder="Enter your company name">
                    </div>
                    
                    <button type="submit" class="submit-btn">Submit & Spin the Wheel</button>
                </form>
                
                <div class="status-bar">
                    <strong>Data Status:</strong><br>
                    Users: <span id="userCount">0</span> | 
                    Spins: <span id="spinCount">0</span>
                </div>
            </div>

            <div id="wheelGame" style="display: none;">
                <div class="user-info" id="userInfo">
                    <h4>Welcome!</h4>
                    <div class="user-details" id="userDetails"></div>
                </div>
                
                <div class="wheel-container">
                    <div class="wheel" id="wheel">
                        <!-- Wheel segments will be generated here -->
                    </div>
                    <div class="wheel-center">SPIN</div>
                    <div class="wheel-pointer"></div>
                </div>
                
                <button class="btn-spin" id="spinBtn">SPIN THE WHEEL</button>
                
                <div class="result">
                    <div>Your prize will appear here</div>
                    <div class="prize-text" id="prizeText">-</div>
                </div>
                
                <div id="gameFirebaseStatus" class="firebase-status status-loading">
                    🔄 Firebase Status
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Admin Panel Button -->
    <div class="bottom-admin-panel">
        <button class="bottom-admin-btn" onclick="showPasswordPanel()">
            ⚙️ Admin Panel
        </button>
    </div>

    <!-- Password Panel -->
    <div class="admin-panel" id="passwordPanel">
        <div class="admin-content">
            <div style="text-align: center;">
                <h2>Admin Access Required</h2>
                <p>Please enter the admin password:</p>
                <input type="password" id="passwordInput" style="width: 100%; padding: 12px; margin: 20px 0; border: 2px solid #ddd; border-radius: 8px;" placeholder="Enter password">
                <button class="submit-btn" onclick="checkPassword()" style="margin: 10px 0;">Access Admin Panel</button>
                <div id="passwordError" style="color: red; margin-top: 10px; display: none;">
                    Incorrect password. Please try again.
                </div>
            </div>
        </div>
    </div>

    <!-- Main Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <div class="admin-content">
            <div class="admin-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">Admin Panel - Complete Management</h2>
                <button class="remove-prize" onclick="hideAdminPanel()" style="margin: 0;">Close</button>
            </div>
            
            <div class="admin-tabs">
                <button class="admin-tab active" onclick="switchAdminTab('prizes')">🎯 Prize Management</button>
                <button class="admin-tab" onclick="switchAdminTab('export')">📊 Data Export</button>
                <button class="admin-tab" onclick="switchAdminTab('analytics')">📈 Analytics</button>
                <button class="admin-tab" onclick="switchAdminTab('settings')">⚙️ Settings</button>
            </div>
            
            <!-- Prize Management Tab -->
            <div id="prizes-tab" class="admin-tab-content active">
                <div class="probability-info">
                    ⓘ Wheel shows equal segments, but prizes have different probabilities
                </div>
                
                <div id="prizesContainer">
                    <!-- Prize items will be generated here -->
                </div>
                
                <div class="probability-total" id="probabilityTotal">
                    Total Probability: 100%
                </div>
                
                <button class="add-prize" onclick="addNewPrize()">+ Add New Prize</button>
                
                <div class="admin-actions">
                    <button class="save-btn" onclick="savePrizeSettings()">💾 Save & Sync to Firebase</button>
                    <button class="reset-btn" onclick="resetToDefault()">🔄 Reset to Default</button>
                </div>
            </div>
            
            <!-- Data Export Tab -->
            <div id="export-tab" class="admin-tab-content">
                <h3>Data Export</h3>
                
                <div class="export-section">
                    <h4>Export User Data</h4>
                    <p>Download all user registration data</p>
                    <div class="export-options">
                        <button class="export-btn" onclick="exportUsersToExcel()">📊 Export to Excel</button>
                        <button class="export-btn" onclick="exportUsersToCSV()">📄 Export to CSV</button>
                    </div>
                    <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                        Total users registered: <span id="adminUserCount">0</span>
                    </p>
                </div>
                
                <div class="export-section">
                    <h4>Export Spin Data</h4>
                    <p>Download all spin history data for analysis</p>
                    <div class="export-options">
                        <button class="export-btn" onclick="exportSpinsToExcel()">📊 Export to Excel</button>
                        <button class="export-btn" onclick="exportSpinsToCSV()">📄 Export to CSV</button>
                    </div>
                    <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                        Total spins available: <span id="adminSpinCount">0</span>
                    </p>
                </div>
            </div>
            
            <!-- Analytics Tab -->
            <div id="analytics-tab" class="admin-tab-content">
                <h3>Analytics Dashboard</h3>
                
                <div class="status-bar">
                    <strong>Real-time Statistics:</strong><br>
                    📊 Total Users: <span id="analyticsUserCount">0</span><br>
                    🎯 Total Spins: <span id="analyticsSpinCount">0</span><br>
                    📈 Spins Today: <span id="spinsToday">0</span><br>
                    👥 Unique Players: <span id="uniquePlayers">0</span>
                </div>
                
                <div class="export-section">
                    <h4>Prize Distribution</h4>
                    <div id="prizeStats">
                        <!-- Prize statistics will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div id="settings-tab" class="admin-tab-content">
                <h3>System Settings</h3>
                
                <div class="export-section">
                    <h4>Firebase Connection</h4>
                    <div id="adminFirebaseStatus" class="firebase-status status-loading">
                        🔄 Checking Firebase connection...
                    </div>
                    <button class="export-btn" onclick="testFirebaseConnection()" style="background: #ffa502;">
                        🔧 Test Firebase Connection
                    </button>
                </div>
                
                <div class="export-section">
                    <h4>Data Management</h4>
                    <button class="export-btn" onclick="clearAllData()" style="background: #ff4757;">
                        🗑️ Clear All Data
                    </button>
                    <p style="font-size: 0.8rem; color: #666; margin-top: 10px;">
                        Warning: This will delete all users and spins data.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== FIREBASE CONFIGURATION ====================
        const firebaseConfig = {
          apiKey: "AIzaSyCY658zB6ORJJTK-JvPI-L2co9yZnMEPR0",
          authDomain: "fortunewheel-772ab.firebaseapp.com",
          projectId: "fortunewheel-772ab",
          storageBucket: "fortunewheel-772ab.firebasestorage.app",
          messagingSenderId: "539367805663",
          appId: "1:539367805663:web:4ab6dae0a1703bd5674f6a",
          measurementId: "G-8K3KP60744"
        };

        // ==================== FIREBASE INITIALIZATION ====================
        let db = null;
        let firebaseInitialized = false;
        const ADMIN_PASSWORD = "admin123";
        
        // Default prizes
        const defaultPrizes = [
            { name: "Discount 10%", probability: 20, color: "#FF6384" },
            { name: "Free Coffee", probability: 15, color: "#36A2EB" },
            { name: "Movie Tickets", probability: 15, color: "#FFCE56" },
            { name: "Gift Card $25", probability: 10, color: "#4BC0C0" },
            { name: "Try Again", probability: 25, color: "#9966FF" },
            { name: "Smartphone", probability: 5, color: "#FF9F40" },
            { name: "Headphones", probability: 5, color: "#FF6384" },
            { name: "Amazon Voucher", probability: 5, color: "#C9CBCF" }
        ];

        let prizes = [];
        let currentUser = null;
        let users = [];
        let spins = [];

        async function initializeFirebase() {
            try {
                updateFirebaseStatus('loading', '🔄 Initializing Firebase...');
                
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                
                // Test connection
                await db.collection('connectionTest').doc('test').set({
                    timestamp: new Date().toISOString()
                });
                
                firebaseInitialized = true;
                updateFirebaseStatus('connected', '✅ Firebase Connected');
                
                // Load prizes and data
                await loadPrizesFromFirebase();
                await loadDataFromFirebase();
                
            } catch (error) {
                console.error('Firebase initialization failed:', error);
                firebaseInitialized = false;
                updateFirebaseStatus('error', '❌ Firebase Error');
                loadDataFromLocalStorage();
                loadPrizesFromLocalStorage();
            }
        }

        // ==================== PRIZE MANAGEMENT ====================
        async function loadPrizesFromFirebase() {
            try {
                const doc = await db.collection('wheelConfig').doc('prizes').get();
                if (doc.exists) {
                    prizes = doc.data().prizes;
                } else {
                    prizes = [...defaultPrizes];
                    await savePrizesToFirebase();
                }
                createWheelSegments();
            } catch (error) {
                console.error('Error loading prizes from Firebase:', error);
                loadPrizesFromLocalStorage();
            }
        }

        function loadPrizesFromLocalStorage() {
            const savedPrizes = localStorage.getItem('wheelPrizes');
            prizes = savedPrizes ? JSON.parse(savedPrizes) : [...defaultPrizes];
            createWheelSegments();
        }

        async function savePrizesToFirebase() {
            try {
                if (firebaseInitialized) {
                    await db.collection('wheelConfig').doc('prizes').set({
                        prizes: prizes,
                        lastUpdated: new Date().toISOString()
                    });
                }
            } catch (error) {
                console.error('Error saving prizes to Firebase:', error);
            }
            localStorage.setItem('wheelPrizes', JSON.stringify(prizes));
        }

        function renderPrizeControls() {
            const container = document.getElementById('prizesContainer');
            container.innerHTML = '';
            
            let totalProbability = 0;
            
            prizes.forEach((prize, index) => {
                totalProbability += prize.probability;
                
                const prizeItem = document.createElement('div');
                prizeItem.className = 'prize-item';
                prizeItem.innerHTML = `
                    <div class="prize-color" style="background-color: ${prize.color}"></div>
                    <div class="prize-inputs">
                        <input type="text" class="prize-name" value="${prize.name}" placeholder="Prize Name">
                        <input type="number" class="prize-probability" value="${prize.probability}" min="1" max="100" placeholder="%">
                        <input type="color" class="prize-color-input" value="${prize.color}">
                    </div>
                    <button class="remove-prize" onclick="removePrize(${index})">×</button>
                `;
                container.appendChild(prizeItem);
            });
            
            document.getElementById('probabilityTotal').textContent = `Total Probability: ${totalProbability}%`;
            document.getElementById('probabilityTotal').style.color = totalProbability === 100 ? 'green' : 'red';
            
            // Add event listeners
            container.querySelectorAll('.prize-name, .prize-probability, .prize-color-input').forEach(input => {
                input.addEventListener('input', updatePrizeFromInputs);
            });
        }

        function updatePrizeFromInputs() {
            const prizeItems = document.querySelectorAll('.prize-item');
            let totalProbability = 0;
            
            prizeItems.forEach((item, index) => {
                const name = item.querySelector('.prize-name').value;
                const probability = parseInt(item.querySelector('.prize-probability').value) || 0;
                const color = item.querySelector('.prize-color-input').value;
                
                prizes[index] = { name, probability, color };
                totalProbability += probability;
                
                item.querySelector('.prize-color').style.backgroundColor = color;
            });
            
            document.getElementById('probabilityTotal').textContent = `Total Probability: ${totalProbability}%`;
            document.getElementById('probabilityTotal').style.color = totalProbability === 100 ? 'green' : 'red';
        }

        function addNewPrize() {
            prizes.push({
                name: "New Prize",
                probability: 10,
                color: "#" + Math.floor(Math.random()*16777215).toString(16)
            });
            renderPrizeControls();
        }

        function removePrize(index) {
            prizes.splice(index, 1);
            renderPrizeControls();
        }

        function savePrizeSettings() {
            updatePrizeFromInputs();
            const totalProbability = prizes.reduce((sum, p) => sum + p.probability, 0);
            
            if (totalProbability !== 100) {
                alert(`Total probability must be 100%. Current total: ${totalProbability}%`);
                return;
            }
            
            savePrizesToFirebase();
            createWheelSegments();
            alert('Prizes saved successfully!');
        }

        function resetToDefault() {
            if (confirm('Are you sure you want to reset to default prizes?')) {
                prizes = [...defaultPrizes];
                savePrizesToFirebase();
                renderPrizeControls();
                createWheelSegments();
            }
        }

        // ==================== WHEEL DISPLAY FUNCTIONS ====================
        function createWheelSegments() {
            const wheel = document.getElementById('wheel');
            wheel.innerHTML = '';
            
            const numberOfSegments = prizes.length;
            const segmentAngle = 360 / numberOfSegments;
            
            // Create conic gradient for the wheel background
            const conicGradient = [];
            prizes.forEach((prize, index) => {
                const startAngle = index * segmentAngle;
                const endAngle = (index + 1) * segmentAngle;
                conicGradient.push(`${prize.color} ${startAngle}deg ${endAngle}deg`);
            });
            
            wheel.style.background = `conic-gradient(${conicGradient.join(', ')})`;
            
            // Create individual segments with text labels
            prizes.forEach((prize, index) => {
                const segment = document.createElement('div');
                segment.className = 'wheel-segment';
                
                const angle = index * segmentAngle;
                segment.style.transform = `rotate(${angle}deg)`;
                
                const text = document.createElement('div');
                text.className = 'segment-text';
                text.textContent = prize.name;
                text.style.color = getContrastColor(prize.color); // Ensure text is readable
                
                segment.appendChild(text);
                wheel.appendChild(segment);
            });
            
            console.log('Wheel created with', prizes.length, 'segments');
        }

        // Helper function to ensure text is readable on any background
        function getContrastColor(hexcolor) {
            const r = parseInt(hexcolor.substr(1, 2), 16);
            const g = parseInt(hexcolor.substr(3, 2), 16);
            const b = parseInt(hexcolor.substr(5, 2), 16);
            const brightness = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            return brightness > 128 ? 'black' : 'white';
        }

        // ==================== DATA MANAGEMENT ====================
        async function loadDataFromFirebase() {
            try {
                // Load users
                const usersSnapshot = await db.collection('users').get();
                users = [];
                usersSnapshot.forEach(doc => {
                    users.push({ id: doc.id, ...doc.data() });
                });
                
                // Load spins
                const spinsSnapshot = await db.collection('spins').get();
                spins = [];
                spinsSnapshot.forEach(doc => {
                    spins.push({ id: doc.id, ...doc.data() });
                });
                
                updateCounts();
                updateAnalytics();
                
            } catch (error) {
                console.error('Error loading from Firebase:', error);
                loadDataFromLocalStorage();
            }
        }

        function loadDataFromLocalStorage() {
            const savedUsers = localStorage.getItem('wheelUsers');
            users = savedUsers ? JSON.parse(savedUsers) : [];
            
            const savedSpins = localStorage.getItem('wheelSpins');
            spins = savedSpins ? JSON.parse(savedSpins) : [];
            
            updateCounts();
            updateAnalytics();
        }

        async function saveUserToFirebase(user) {
            try {
                if (firebaseInitialized) {
                    const userData = {
                        name: user.name,
                        email: user.email,
                        phone: user.phone,
                        company: user.company || 'Not provided',
                        registrationDate: new Date().toLocaleDateString(),
                        registrationTime: new Date().toLocaleTimeString(),
                        timestamp: new Date().toISOString()
                    };
                    
                    await db.collection('users').add(userData);
                }
            } catch (error) {
                console.error('Error saving user to Firebase:', error);
            }
            
            saveUserToLocalStorage(user);
        }

        async function saveSpinToFirebase(prize, user) {
            try {
                if (firebaseInitialized) {
                    const spinData = {
                        prize: prize.name,
                        userEmail: user ? user.email : 'Guest',
                        userName: user ? user.name : 'Guest',
                        userPhone: user ? user.phone : 'N/A',
                        userCompany: user ? user.company : 'N/A',
                        timestamp: new Date().toISOString(),
                        date: new Date().toLocaleDateString(),
                        time: new Date().toLocaleTimeString()
                    };
                    
                    await db.collection('spins').add(spinData);
                }
            } catch (error) {
                console.error('Error saving spin to Firebase:', error);
            }
            
            saveSpinToLocalStorage(prize, user);
        }

        function saveUserToLocalStorage(user) {
            const existingIndex = users.findIndex(u => u.email === user.email);
            if (existingIndex === -1) {
                users.push(user);
            } else {
                users[existingIndex] = user;
            }
            localStorage.setItem('wheelUsers', JSON.stringify(users));
            localStorage.setItem('currentUser', JSON.stringify(user));
            updateCounts();
            updateAnalytics();
        }

        function saveSpinToLocalStorage(prize, user) {
            const spin = {
                id: Date.now().toString(),
                prize: prize.name,
                userEmail: user ? user.email : 'Guest',
                userName: user ? user.name : 'Guest',
                userPhone: user ? user.phone : 'N/A',
                userCompany: user ? user.company : 'N/A',
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString()
            };
            
            spins.push(spin);
            localStorage.setItem('wheelSpins', JSON.stringify(spins));
            updateCounts();
            updateAnalytics();
        }

        // ==================== UI FUNCTIONS ====================
        function updateFirebaseStatus(status, message) {
            const elements = ['firebaseStatus', 'gameFirebaseStatus', 'adminFirebaseStatus'];
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = message;
                    element.className = `firebase-status status-${status}`;
                }
            });
        }

        function updateCounts() {
            document.getElementById('userCount').textContent = users.length;
            document.getElementById('spinCount').textContent = spins.length;
            document.getElementById('adminUserCount').textContent = users.length;
            document.getElementById('adminSpinCount').textContent = spins.length;
        }

        function updateAnalytics() {
            document.getElementById('analyticsUserCount').textContent = users.length;
            document.getElementById('analyticsSpinCount').textContent = spins.length;
            
            // Calculate spins today
            const today = new Date().toDateString();
            const spinsToday = spins.filter(spin => new Date(spin.timestamp).toDateString() === today).length;
            document.getElementById('spinsToday').textContent = spinsToday;
            
            // Calculate unique players
            const uniqueEmails = new Set(spins.map(spin => spin.userEmail));
            document.getElementById('uniquePlayers').textContent = uniqueEmails.size;
            
            // Prize distribution
            const prizeStats = document.getElementById('prizeStats');
            if (prizeStats) {
                const distribution = {};
                spins.forEach(spin => {
                    distribution[spin.prize] = (distribution[spin.prize] || 0) + 1;
                });
                
                prizeStats.innerHTML = Object.entries(distribution)
                    .map(([prize, count]) => `
                        <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee;">
                            <span>${prize}</span>
                            <span style="font-weight: bold;">${count} (${((count/spins.length)*100).toFixed(1)}%)</span>
                        </div>
                    `).join('');
            }
        }

        // ==================== APPLICATION INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase().then(() => {
                createWheelSegments();
                
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    showWheelGame();
                }
            });

            document.getElementById('userForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                currentUser = {
                    id: Date.now().toString(),
                    name: formData.get('name'),
                    phone: formData.get('phone'),
                    email: formData.get('email'),
                    company: formData.get('company') || 'Not provided',
                    registrationDate: new Date().toLocaleDateString(),
                    registrationTime: new Date().toLocaleTimeString(),
                    timestamp: new Date().toISOString()
                };

                await saveUserToFirebase(currentUser);
                showWheelGame();
            });

            document.getElementById('spinBtn').addEventListener('click', spinWheel);
        });

        function showWheelGame() {
            document.getElementById('registrationForm').style.display = 'none';
            document.getElementById('wheelGame').style.display = 'block';
            
            if (currentUser) {
                document.getElementById('userDetails').innerHTML = `
                    <strong>Name:</strong> ${currentUser.name}<br>
                    <strong>Phone:</strong> ${currentUser.phone}<br>
                    <strong>Email:</strong> ${currentUser.email}
                    ${currentUser.company ? `<br><strong>Company:</strong> ${currentUser.company}` : ''}
                `;
            }
        }

        async function spinWheel() {
            const spinBtn = document.getElementById('spinBtn');
            const wheel = document.getElementById('wheel');
            const prizeText = document.getElementById('prizeText');
            
            spinBtn.disabled = true;
            spinBtn.textContent = "Spinning...";
            wheel.style.transition = 'none';
            wheel.style.transform = 'rotate(0deg)';
            void wheel.offsetWidth;

            // Determine prize based on probability
            const randomValue = Math.random() * 100;
            let cumulativeProbability = 0;
            let selectedPrizeIndex = 0;
            
            for (let i = 0; i < prizes.length; i++) {
                cumulativeProbability += prizes[i].probability;
                if (randomValue <= cumulativeProbability) {
                    selectedPrizeIndex = i;
                    break;
                }
            }

            // Calculate rotation (5 full rotations + offset to land on selected prize)
            const fullRotations = 5;
            const segmentAngle = 360 / prizes.length;
            const selectedSegmentMiddle = selectedPrizeIndex * segmentAngle + (segmentAngle / 2);
            const finalRotation = fullRotations * 360 + (360 - selectedSegmentMiddle);
            
            // Add some random variation for natural feel
            const randomVariation = (Math.random() - 0.5) * (segmentAngle * 0.8);
            const finalRotationWithVariation = finalRotation + randomVariation;
            
            wheel.style.transition = 'transform 4s cubic-bezier(0.17, 0.67, 0.83, 0.67)';
            wheel.style.transform = `rotate(${finalRotationWithVariation}deg)`;

            setTimeout(async function() {
                const actualPrize = prizes[selectedPrizeIndex];
                prizeText.textContent = actualPrize.name;
                prizeText.parentElement.classList.add('celebrate');
                
                await saveSpinToFirebase(actualPrize, currentUser);
                
                spinBtn.disabled = false;
                spinBtn.textContent = "SPIN THE WHEEL";
                setTimeout(() => prizeText.parentElement.classList.remove('celebrate'), 1500);
            }, 4000);
        }

        // ==================== ADMIN PANEL FUNCTIONS ====================
        function showPasswordPanel() {
            document.getElementById('passwordPanel').style.display = 'flex';
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordError').style.display = 'none';
        }

        function checkPassword() {
            const password = document.getElementById('passwordInput').value;
            if (password === ADMIN_PASSWORD) {
                document.getElementById('passwordPanel').style.display = 'none';
                showAdminPanel();
            } else {
                document.getElementById('passwordError').style.display = 'block';
            }
        }

        function showAdminPanel() {
            updateCounts();
            updateAnalytics();
            renderPrizeControls();
            document.getElementById('adminPanel').style.display = 'flex';
        }

        function hideAdminPanel() {
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('passwordPanel').style.display = 'none';
        }

        function switchAdminTab(tabName) {
            document.querySelectorAll('.admin-tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.admin-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'analytics') {
                updateAnalytics();
            }
        }

        async function testFirebaseConnection() {
            try {
                updateFirebaseStatus('loading', '🔄 Testing Firebase Connection...');
                await db.collection('connectionTest').doc('test').set({ timestamp: new Date().toISOString() });
                updateFirebaseStatus('connected', '✅ Firebase Connection Test Successful!');
                alert('Firebase connection test successful!');
            } catch (error) {
                updateFirebaseStatus('error', '❌ Connection Test Failed');
                alert('Connection test failed: ' + error.message);
            }
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear ALL data? This cannot be undone.')) {
                users = [];
                spins = [];
                localStorage.removeItem('wheelUsers');
                localStorage.removeItem('wheelSpins');
                localStorage.removeItem('currentUser');
                updateCounts();
                updateAnalytics();
                alert('All data has been cleared.');
            }
        }

        // ==================== EXPORT FUNCTIONS ====================
        function exportUsersToExcel() {
            if (users.length === 0) {
                alert('No user data available to export.');
                return;
            }

            const usersData = users.map(user => ({
                'Name': user.name,
                'Email': user.email,
                'Phone': user.phone,
                'Company': user.company,
                'Registration Date': user.registrationDate,
                'Registration Time': user.registrationTime
            }));

            try {
                const worksheet = XLSX.utils.json_to_sheet(usersData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Users');
                XLSX.writeFile(workbook, `wheel_users_${new Date().toISOString().split('T')[0]}.xlsx`);
                alert(`Successfully exported ${users.length} users to Excel!`);
            } catch (error) {
                alert('Error exporting to Excel: ' + error.message);
            }
        }

        function exportSpinsToExcel() {
            if (spins.length === 0) {
                alert('No spin data available to export.');
                return;
            }

            const spinsData = spins.map(spin => ({
                'Prize': spin.prize,
                'User Name': spin.userName,
                'User Email': spin.userEmail,
                'User Phone': spin.userPhone,
                'Company': spin.userCompany,
                'Date': spin.date,
                'Time': spin.time
            }));

            try {
                const worksheet = XLSX.utils.json_to_sheet(spinsData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Spins');
                XLSX.writeFile(workbook, `wheel_spins_${new Date().toISOString().split('T')[0]}.xlsx`);
                alert(`Successfully exported ${spins.length} spins to Excel!`);
            } catch (error) {
                alert('Error exporting to Excel: ' + error.message);
            }
        }

        function exportUsersToCSV() {
            if (users.length === 0) {
                alert('No user data available to export.');
                return;
            }

            const usersData = users.map(user => ({
                'Name': user.name,
                'Email': user.email,
                'Phone': user.phone,
                'Company': user.company,
                'Registration Date': user.registrationDate,
                'Registration Time': user.registrationTime
            }));

            try {
                const worksheet = XLSX.utils.json_to_sheet(usersData);
                const csv = XLSX.utils.sheet_to_csv(worksheet);
                downloadCSV(csv, `wheel_users_${new Date().toISOString().split('T')[0]}.csv`);
                alert(`Successfully exported ${users.length} users to CSV!`);
            } catch (error) {
                alert('Error exporting to CSV: ' + error.message);
            }
        }

        function exportSpinsToCSV() {
            if (spins.length === 0) {
                alert('No spin data available to export.');
                return;
            }

            const spinsData = spins.map(spin => ({
                'Prize': spin.prize,
                'User Name': spin.userName,
                'User Email': spin.userEmail,
                'User Phone': spin.userPhone,
                'Company': spin.userCompany,
                'Date': spin.date,
                'Time': spin.time
            }));

            try {
                const worksheet = XLSX.utils.json_to_sheet(spinsData);
                const csv = XLSX.utils.sheet_to_csv(worksheet);
                downloadCSV(csv, `wheel_spins_${new Date().toISOString().split('T')[0]}.csv`);
                alert(`Successfully exported ${spins.length} spins to CSV!`);
            } catch (error) {
                alert('Error exporting to CSV: ' + error.message);
            }
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Close panels when clicking outside
        document.getElementById('adminPanel').addEventListener('click', function(event) {
            if (event.target === this) hideAdminPanel();
        });
        
        document.getElementById('passwordPanel').addEventListener('click', function(event) {
            if (event.target === this) hideAdminPanel();
        });
    </script>
</body>
</html>
